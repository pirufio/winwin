package com.winwin.andoid.app;

import java.io.IOException;

import org.apache.http.client.ClientProtocolException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.*;
import org.json.JSONObject;

import android.animation.ArgbEvaluator;
import android.app.Activity;
import android.os.AsyncTask;
import android.os.Bundle;
import android.provider.SyncStateContract.Helpers;
import android.support.v7.app.ActionBarActivity;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

import com.winwin.config.Constants;
import com.winwin.http.HttpServiceHandler;
import com.winwin.models.dto.UserLoginDTO;

public class MainActivity extends ActionBarActivity {

	 /** Called when the activity is first created.
     * @param savedInstanceState */
    @Override
    public void onCreate(Bundle savedInstanceState)
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        Button loginButton = (Button)findViewById(R.id.btn_login);
        loginButton.setOnClickListener(loginButtonOnClick);
    }
    
    private View.OnClickListener loginButtonOnClick 
            = new View.OnClickListener() {

        public void onClick(View v) {
            String[] args = {Constants.BaseUrl + "/api/login"};
            new HttpAsyncTask().execute(args);
        }
    };
    
    private class HttpAsyncTask extends AsyncTask<String, Void, String> {
    	int httpStatusCode;
        @Override
        protected String doInBackground(String... urls) {
        	HttpServiceHandler handler = new HttpServiceHandler();
            UserLoginDTO userLoginDto = new UserLoginDTO(
            		((EditText)findViewById(R.id.email))
                    .getText()
                    .toString(),
                    ((EditText)findViewById(R.id.password))
                    .getText()
                    .toString());
            ObjectMapper mapper = new ObjectMapper();
            String jsonString = "";
            String result = "";
			try {
				jsonString = mapper.writeValueAsString(userLoginDto);
			} catch (JsonGenerationException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			} catch (JsonMappingException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			} 
            try {
				result = handler.postAsJson(urls[0], jsonString);
			} catch (ClientProtocolException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
            httpStatusCode = handler.getHttpStatusCode();
            return result;
        }
        // onPostExecute displays the results of the AsyncTask.
        @Override
        protected void onPostExecute(String result) {
        	if(httpStatusCode == 200)
        	{
        		Toast.makeText(getBaseContext(), "Login OK!", Toast.LENGTH_LONG).show();
        	}else{
        		Toast.makeText(getBaseContext(), result, Toast.LENGTH_LONG).show();
        	}
       
        }
    }

}
